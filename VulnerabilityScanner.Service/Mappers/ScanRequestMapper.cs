using VulnerabilityScanner.Models;
using VulnerabilityScanner.Service.Helpers;
using VulnerabilityScanner.Service.Models.Requests;

namespace VulnerabilityScanner.Service.Mappers;

public class ScanRequestMapper : IMapper<ScanRequest, Project>
{
    private readonly IDependenciesParser _dependenciesParser;
    private readonly ILogger<ScanRequestMapper> _logger;

    public ScanRequestMapper(IDependenciesParser dependenciesParser, ILogger<ScanRequestMapper> logger)
    {
        _dependenciesParser = dependenciesParser;
        _logger = logger;
    }

    public Project Map(ScanRequest input)
    {
        var fileContentDecodedJson = EncodingHelper.Base64Decode(input.FileContent);
        if (!Enum.TryParse<ProjectEcosystem>(input.Ecosystem, out var ecosystem))
        {
            _logger.LogError("Can't parse presented project ecosystem {ecosystem}", ecosystem);
            //todo: change with validation error
            throw new Exception();
        }

        return new Project
        {
            Ecosystem = ecosystem,
            ProjectDependencies = _dependenciesParser.ParseDependencies(ecosystem, fileContentDecodedJson)
        };
    }
}

public interface IMapper<in TIn, out TOut>
{
    TOut Map(TIn input);
}