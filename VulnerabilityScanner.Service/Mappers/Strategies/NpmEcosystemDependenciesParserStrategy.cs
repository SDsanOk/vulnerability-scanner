using Newtonsoft.Json.Linq;
using VulnerabilityScanner.Models;

namespace VulnerabilityScanner.Service.Mappers.Strategies;

public class NpmEcosystemDependenciesParserStrategy : IDependenciesParserStrategy
{
    public bool IsApplicable(ProjectEcosystem ecosystem) =>
        ecosystem == ProjectEcosystem.Npm;

    public IEnumerable<ProjectDependency> Parse(string fileContent)
    {
        var fileContentJObject = JObject.Parse(fileContent);
        var dependenciesNode = fileContentJObject.Property("dependencies");
        var projectDependenciesDictionary = dependenciesNode?.ToObject<Dictionary<string, Version>>();
        var projectDependencies = projectDependenciesDictionary.Select(x => new ProjectDependency
        {
            Name = x.Key,
            Version = x.Value
        });

        return projectDependencies;
    }
}

public interface IDependenciesParserStrategy
{
    bool IsApplicable(ProjectEcosystem ecosystem);
    IEnumerable<ProjectDependency> Parse(string fileContent);
}