using Newtonsoft.Json.Linq;
using VulnerabilityScanner.Models;
using VulnerabilityScanner.Service.Interfaces;

namespace VulnerabilityScanner.Service.Parsers.Strategies;

public class NpmEcosystemDependenciesParserStrategy : IDependenciesParserStrategy
{
    private static readonly char[] TrimCharacters = new[] { '^', '~' };

    public bool IsApplicable(ProjectEcosystem ecosystem) =>
        ecosystem == ProjectEcosystem.Npm;

    public IEnumerable<ProjectDependency> Parse(string fileContent)
    {
        var fileContentJObject = JObject.Parse(fileContent);
        var dependenciesNode = fileContentJObject.Property("dependencies");
        var projectDependenciesDictionary = dependenciesNode?.Value.ToObject<Dictionary<string, String>>();
        var projectDependencies = projectDependenciesDictionary.Select(x => new ProjectDependency
        {
            Name = x.Key,
            Version = Version.Parse(x.Value.Trim(TrimCharacters))
        });

        return projectDependencies;
    }
}
